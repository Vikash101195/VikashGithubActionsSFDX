name: Deploying components through githubActions

on: 
  push:
     branches: [main]
     paths:
        - 'force-app/**'

jobs:
   Deploy-to-SF-org:
       runs-on: ubuntu-latest
       steps:
         - name: 'Install NodeJS'
           uses: actions/setup-node@v3
           with:
             node-version: '18'

         - name: 'Checkout code'
           uses: actions/checkout@v3
           with: 
             fetch-depth: '2'

         - name: 'Install SFDX CLI'
           run: npm install @salesforce/cli --global

         - name: 'Insall SFDX git delta'
           run: |
              echo Y | sfdx plugins:install sfdx-git-delta
              sfdx plugins

         - name: 'Create Delta package'
           run: |
              mkdir Delta-changes
              sf sgd source delta --to "HEAD" --from "HEAD~1" -o Delta-changes/ --generate-delta -s force-app/
              echo "Differences Generated"
         - name: 'Finding Test Classes'
           id: delta
           run: |
             #!/bin/bash
             set -euo pipefail

             TEST_CLASSES=""
             echo "Scanning for Test Classes"

             # Prefer sgd-generated delta if it exists, otherwise compute git diff
             if [ -d "Delta-changes/force-app" ] && [ "$(find Delta-changes/force-app -type f | wc -l)" -gt 0 ]; then
               echo "Using Delta-changes generated by sgd"
               CHANGED_FILES=$(find Delta-changes/force-app -type f | sed 's|^Delta-changes/||')
             else
               echo "Computing delta against previous commit..."
               CHANGED_FILES=$(git diff --diff-filter=AM --name-only HEAD^ HEAD || true)
             fi

             if [ -z "$CHANGED_FILES" ]; then
               echo "No added/modified files found. Nothing to deploy."
               echo "test_classes=" >> $GITHUB_OUTPUT
               exit 0
             fi

             echo "$CHANGED_FILES" | grep '^force-app/' >/dev/null || {
               echo "No changes under force-app. Nothing to deploy."
               echo "test_classes=" >> $GITHUB_OUTPUT
               exit 0
             }

             echo "$CHANGED_FILES" | while read -r file; do
               echo "Adding $file to Delta-changes"
               mkdir -p "Delta-changes/$(dirname "$file")"
               cp "$file" "Delta-changes/$file" 2>/dev/null || true

               # If this is an Apex class, check if it is a test class (@isTest)
               if [[ "$file" == */classes/*.cls ]]; then
                 if grep -q "@isTest" "$file"; then
                   classname=$(basename "$file" .cls)
                   echo "Detected test class: $classname"
                   if [ -z "$TEST_CLASSES" ]; then
                     TEST_CLASSES="$classname"
                   else
                     TEST_CLASSES="$TEST_CLASSES,$classname"
                   fi
                 fi
               fi
             done

             # Also scan any class files in the delta directory for @isTest
             while IFS= read -r file; do
               if grep -q "@isTest" "$file"; then
                 classname=$(basename "$file" .cls)
                 if [[ ",${TEST_CLASSES}," != *",${classname},"* ]]; then
                   if [ -z "$TEST_CLASSES" ]; then
                     TEST_CLASSES="$classname"
                   else
                     TEST_CLASSES="$TEST_CLASSES,$classname"
                   fi
                 fi
               fi
             done < <(find Delta-changes/force-app -name '*.cls' 2>/dev/null || true)

             echo "Final test classes: $TEST_CLASSES"
             echo "test_classes=$TEST_CLASSES" >> $GITHUB_OUTPUT

             echo "Delta contents:"
             find Delta-changes || echo "No files in delta."

         - name: 'Authorize the org'
           run: | 
              echo "${{ secrets.SERVER_KEY }}" > server.key

              sf org login jwt -f server.key -i ${{ secrets.CONSUMER_KEY }} -o ${{ secrets.USERNAME }} -a devhub

              echo "Org Authentication is succesfull"
         - name: 'Deploy Changes to Org'

           env: 
              TEST_CLASSES: ${{ steps.delta.outputs.test_classes }}
           run: |
             if [ ! -d "Delta-changes/force-app" ]; then
             echo "No delta changes to deploy. Exiting."
             exit 0
             fi

              # Default behavior if no test classes are found
             
              TEST_LEVEL="NoTestRun"
              TEST_ARGS=""

              if [ -n "$TEST_CLASSES" ]; then
              echo "Using RunSpecifiedTests with: $TEST_CLASSES"
              TEST_LEVEL="RunSpecifiedTests"
              TEST_ARGS="-r $TEST_CLASSES"
              else
              echo "No test classes detected in this commit."
              echo "Falling back to NoTestRun."
              # If you want to FAIL instead, uncomment the next line and remove fallback:
              # exit 1
             fi

              sfdx force:source:deploy -p Delta-changes/force-app -u --target-org devhub -l $TEST_LEVEL $TEST_ARGS --json --verbose

             # sf project deploy start --source-dir Delta-changes/force-app --test-level RunLocalTests  --target-org devhub     


